---
title: "Macrofauna P/B ratio"
author: "Chih-Lin Wei"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(bbbs)
library(BenthicPro)
library(ggplot2)
library(plyr)
library(doBy)
library(readxl)

large <- theme(legend.title = element_text(size=20),
        legend.text = element_text(size=20),
        axis.title = element_text(size=20),
        axis.text = element_text(size=20))
rotate <- theme(axis.text.x = element_text(size=20, angle=60, hjust=0.5))

# dark theme for ggplot
dark <- theme(plot.background = element_rect(colour = 'NA', fill = 'gray10'),
        panel.background = element_rect(colour = 'NA', fill = 'transparent'),
        legend.background = element_rect(colour = 'NA', fill = 'transparent'),
        legend.title = element_text(colour = 'white', size=20),
        legend.text = element_text(colour = 'white', size=20),
        axis.title = element_text(colour = 'white', size=20),
        axis.text = element_text(colour = 'white', size=20),
        axis.ticks = element_line(colour = 'white'),
        panel.border = element_rect(fill = 'NA', colour = 'white'), 
        panel.grid.major = element_line(colour = 'gray30'),
        panel.grid.minor = element_line(colour = 'gray20'))
```

```{r}
dat <- subset(mac, Cruise=="OR1_1096"|Cruise=="OR1_1102"|Cruise=="OR1_1114"|Cruise=="OR1_1126"|Cruise=="OR1_1128"|Cruise=="OR1_1132")
dat.sum <- summaryBy(Wt~Habitat+Cruise+Station+Deployment+Tube+Taxon, data=dat, FUN=c(sum, length))
names(dat.sum)[-1:-6] <- c("Wt", "Count")
dat.sum$Sample.area <- mac$Area[match(with(dat.sum, paste(Cruise, Station)), with(mac, paste(Cruise, Station)))]

# Convert the numbers of polychaete specimen (with head) to abundance
pols <- subset(mac, Taxon=="Polychaeta" & (Condition=="FH" | Condition=="C" | Condition=="FHT"))
pola <- summaryBy(Wt~Habitat+Cruise+Station+Deployment+Tube+Taxon, data=pols, FUN=length, var.names="Count", keep.names = T)
keep <- match(with(pola, paste(Cruise, Station, Deployment, Tube, Taxon)), with(dat.sum, paste(Cruise, Station, Deployment, Tube, Taxon)))
dat.sum$Count[keep] <- pola$Count

# Convert the numbers of complete ophiroid specimens to abundance
ophs <- subset(mac, Taxon=="Ophiuroidea" & Condition=="C")
opha <- summaryBy(Wt~Habitat+Cruise+Station+Deployment+Tube+Taxon, data=ophs, FUN=length, var.names="Count", keep.names = T)
keep <- match(with(opha, paste(Cruise, Station, Deployment, Tube, Taxon)), with(dat.sum, paste(Cruise, Station, Deployment, Tube, Taxon)))
dat.sum$Count[keep] <- opha$Count

# 
tr <- read.csv("../excel/trait_wei.csv")
dat.sum <- cbind(dat.sum, tr[match(dat.sum$Taxon, tr$Taxon), c("ConFac_j2mgwm", "ConFac_j2mgc")])
dat.sum$Bodymass <- dat.sum$Wt*dat.sum$ConFac_j2mgwm/dat.sum$Count
dat.sum <- cbind(dat.sum, env[match(with(dat.sum, paste(Cruise, Station)), with(env, paste(Cruise, Station))), c("Temperature", "Depth")])
dat.sum <- cbind(dat.sum, tr[match(dat.sum$Taxon, tr$Taxon), c(-1:-3, -21)])


individualPB<-BenthicPB(dat.sum)
PBresults<-cbind(dat.sum,individualPB)

# annual secondary production in Joule per species and sample per square meter
PBresults$productionJ<-PBresults$annual.PtoB*PBresults$Bodymass*PBresults$Count/PBresults$Sample.area

# conversion from Joule to gram carbon per square meter
PBresults$productionC<-productionJ/(PBresults$ConFac_j2mgc*1000)/PBresults$Sample.area
PBresults$biomassC<-PBresults$Bodymass*PBresults$Count/(PBresults$ConFac_j2mgc*1000)/PBresults$Sample.area

# Summation by tube
p2b <- summaryBy(Depth+annual.PtoB+lowerCI+upperCI~Habitat+Cruise+Station+Deployment+Tube, data = PBresults, fun = mean, keep.names = TRUE)
pd <- summaryBy(productionJ+productionC+biomassC~Habitat+Cruise+Station+Deployment+Tube, data = PBresults, fun = sum, keep.names = TRUE)
pd <- cbind(p2b, pd[, -1:-5])

se <- function(x) sd(x)/length(x)^0.5

out <- summaryBy(Depth+annual.PtoB+lowerCI+upperCI+productionJ+productionC+biomassC~Habitat+Cruise+Station, data = pd, FUN = c(mean, sd, length, se))

#out <- cbind(Taxon=unique(c(mei$Taxon, mac$Taxon)), ConFac_j2mgwm=NA, Mollusca=NA, Annelida=NA, Crustacea=NA, Echinodermata=NA, Insecta=NA, Infauna=NA, Sessile=NA, Crawler=NA, FacultativeSwimmer=NA, Herbivore=NA, Omnivore=NA, Carnivore=NA, Lake=NA, River=NA, Marine=NA, Subtidal=NA, Exploited=NA)
#write.csv(out, na="", row.names=FALSE, file="../excel/trait.csv")
#write.csv(BenthProdExampleData, na="", row.names=FALSE, file="../excel/BenthProdExampleData.csv")
```

```{r, fig.height=5, fig.width=7}
ggplot(data=out, 
       aes(x=Depth, y=log10(biomassC.mean), 
           ymin=log10(biomassC.mean-biomassC.se), ymax=log10(biomassC.mean+biomassC.se),
           shape=Habitat, colour=Habitat, linetype=Habitat))+
  geom_point(size=5)+
  stat_smooth(method="lm", formula=y~x)+
  geom_errorbar(linetype=1)+
  scale_colour_manual(values=c("black","gray30"))+
  #scale_fill_manual(values=c("black","gray"))+
  scale_linetype_manual(values=c(1,2))+
  scale_shape_manual(values=c(19,1))+
  labs(x="Depth (m)", y=expression(Log[10]~biomass~(mg~m^-2)))+
  #scale_y_log10()+
  theme_bw() %+replace% large #%+replace% dark
```

