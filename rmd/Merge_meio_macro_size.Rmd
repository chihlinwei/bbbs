---
title: "Merge macrofauna and meiofauna size"
author: "Chih-Lin Wei"
date: "2020/3/4"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(bbbs)
library(ggplot2)
library(plyr)
library(doBy)
library(readxl)
library(doSNOW)
library(foreach)

large <- theme(legend.title = element_text(size=20),
        legend.text = element_text(size=20),
        strip.text=element_text(size=20),
        axis.title = element_text(size=20),
        axis.text.y = element_text(size=20),
        axis.text.x = element_text(size=20, angle=60, hjust=0.5))

rotate <- theme(axis.text.x = element_text(size=20, angle=60, hjust=0.5))

# dark theme for ggplot
dark <- theme(plot.background = element_rect(colour = 'NA', fill = 'gray10'),
        panel.background = element_rect(colour = 'NA', fill = 'transparent'),
        legend.background = element_rect(colour = 'NA', fill = 'transparent'),
        legend.title = element_text(colour = 'white', size=20),
        legend.text = element_text(colour = 'white', size=20),
        axis.title = element_text(colour = 'white', size=20),
        axis.text = element_text(colour = 'white', size=20),
        axis.ticks = element_line(colour = 'white'),
        panel.border = element_rect(fill = 'NA', colour = 'white'), 
        panel.grid.major = element_line(colour = 'gray30'),
        panel.grid.minor = element_line(colour = 'gray20'))
```

# Resample macrofauna size data
There are two reasons that we need to simulate the macrofauna size distribution. Firstly, we sampled, on average, three core tubes per cruise/station; however, it was not always the case. Therefore, we need to re-sample the individual size data to the average number of individuals in 3 core tubes.  Secondly, polychaetes are easy to break off; the size data of complete polychaete specimens were re-sampled to match the numbers of individual polychaete with head (prostomium).

```{r, fig.width=10, fig.height=8}
# Size (complete macrofauna specimen)
mac_s <- subset(mac, Condition=="C")
mac_s <- splitBy(~Category+Cruise+Station, mac_s)

# Abundance (specimen with head)
mac_a <- subset(mac, !(Condition=="F" | is.na(Condition)))
mac_a <- summaryBy(Taxon~Category+Cruise+Station+Deployment+Tube, data=mac_a, FUN=length, var.names="Abundance", keep.names=TRUE)

# Average by Cruise/Station and then scale the abundance to 3 multicore tubes
mac_a <- summaryBy(Abundance~Category+Cruise+Station, data=mac_a, FUN=mean, var.names="Abundance", keep.names=TRUE)
mac_a$Abundance <- mac_a$Abundance*3

# Total abundce in each sample
sn <- with(mac_a, paste(Category, Cruise, Station, sep="|"))
abund <- mac_a[match(names(mac_s), sn),]$Abundance

# Resample the size data (with replacement) by the total abundance in each sample
sample_fun <-
  function(i){
    keep <- sample(1:dim(mac_s[[i]])[1], si=abund[i], replace=TRUE)
    mac_s[[i]][keep,]
  }

# Simulated macrofauna size data
cl<-makeCluster(4) # change the 4 to your number of CPU cores
registerDoSNOW(cl) # register the SNOW parallel backend with the foreach package
simu <- foreach(i=1:length(mac_s)) %dopar% sample_fun(i)
stopCluster(cl) # stop a SNOW cluster

ggplot(data=ldply(simu), 
       aes(x=log10(Wt), fill=Habitat, colour=Habitat))+
  geom_density(alpha=0.5)+
  facet_wrap(~Cruise, scales="free")+
  labs(y="Frequency", x=expression(Log[10]~body~size~(mg)))+
  theme_bw() %+replace% large %+replace% dark

mac_s <- ldply(simu)
```

```{r, fig.width=10, fig.height=4}
# Only show 1096, 1114, 1126 macrofauna size simulation because only these cruise have ok polychaete sizes
ggplot(data=subset(mac_s, Cruise=="OR1_1096"|Cruise=="OR1_1114"|Cruise=="OR1_1126"), 
       aes(x=log10(Wt), fill=Habitat, colour=Habitat))+
  geom_density(alpha=0.5)+
  facet_wrap(~Cruise, scales="free_y")+
  labs(y="Frequency", x=expression(Log[10]~body~size~(mg)))+
  theme_bw() %+replace% large %+replace% dark
```
Only cruise 1096, 1114, and 1126 can be merged

# Simulated meiofauna size distribtution
Because not all specimens were measured for their sizes, the size distribution of nematodes (from 100 random individuals), harpacticoids and other taxa (as many as possible) were scaled to the total abundance in the samples by resampling the observed size measurement (with replacement).

```{r, fig.width=10, fig.height=6}
# Sorting data
mei_a   <- read_excel("../excel/GPSC_meio_sorting_2016.08.18.xlsx", sheet=2)
Category <- as.character(mei_a$Taxon)
Category[Category=="Copepoda"] <- "Harpacticoida"
Category[Category!="Nematoda"&Category!="Harpacticoida"] <- "Others"
mei_a <- cbind(Category, mei_a)
mei_a <- subset(mei_a, Subcore!="water")
mei_a <- summaryBy(Abundance~Category+Cruise+Station+Taxon, data=mei_a, FUN=c(mean, sd, length), keep.names=T)
names(mei_a)[5:7] <- c("Abundance", "sd", "n")

# Scale the meiofauna abundance to the area of 3 multicore tube
mei_a$Abundance <- round(mei_a$Abundance*(10.5/2)^2/(2.5/2)^2)*3
mei_a$sd <- round(mei_a$sd*(10.5/2)^2/(2.5/2)^2)*3

# Match the sample names (tube) in size data to the sample names (tube) in sorting data 
# Extract the total abudance from the sorting data 
sn <- with(mei_a, paste(Category, Cruise, Station, sep="|"))
mei <- splitBy(~Category+Cruise+Station, mei)
abund <- mei_a[match(names(mei), sn),]$Abundance

# Resample the size data (with replacement) by the total abundance in each sample
sample_fun <-
  function(i){
    keep <- sample(1:dim(mei[[i]])[1], si=abund[i], replace=TRUE)
    mei[[i]][keep,]
  }

# Simulated size data
cl<-makeCluster(4) # change the 4 to your number of CPU cores
registerDoSNOW(cl) # register the SNOW parallel backend with the foreach package
simu <- foreach(i=1:length(mei)) %dopar% sample_fun(i)
stopCluster(cl) # stop a SNOW cluster

ggplot(data=subset(ldply(simu), Cruise=="OR1_1114"|Cruise=="OR1_1126"), 
       aes(x=log10(Wt), fill=Habitat, colour=Habitat))+
  geom_density(alpha=0.5)+
  facet_grid(Cruise~Category, scale="free")+
  labs(y="Frequency", x=expression(Log[10]~body~size~(mg)))+
  theme_bw()%+replace% dark

mei_s <- ldply(simu)
```
Both 1114 and 1126 meiofauna can be merged with macrofauna

# Merge meiofauna and macrofauna
```{r, fig.width=10, fig.height=6}
# OR1 1114, 1126
si <- merge(cbind(Class="Meiofauna", mei_s), cbind(Class="Macrofauna", mac_s), all=T)
si$Habitat <- factor(si$Habitat, levels=c("Canyon", "Slope"))

# Only use 1126 data in which the meiofauna data are available
si <- si[grep("1114|1126", si$Cruise),]

ggplot(data=subset(si, Category!="Others"), 
       aes(x=log10(Wt), fill=Habitat, colour=Habitat))+
  geom_density(alpha=0.5)+
  facet_wrap(~Category, scales="free")+
  labs(y="Frequency", x=expression(Log[10]~body~size~(mg)))+
  theme_bw()%+replace% dark %+replace% rotate
```

```{r}
save(si, file="../data/si.rda")
```

