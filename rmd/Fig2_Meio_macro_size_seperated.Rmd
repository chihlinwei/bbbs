---
title: "Meiofauna and Macrofauna Size Spectrum"
author: "Chih-Lin Wei"
date: "`r Sys.Date()`"
output: 
  html_document:
    toc: true # table of content true
    toc_depth: 3  # upto three depths of headings (specified by #, ## and ###) 
    toc_float: true
    number_sections: true  ## if you want number sections at each table header
    theme: united  # many options for theme, this one is my favorite.
    highlight: tango  # specifies the syntax highlighting style
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE)
```

Analyze meiofauna size (from OR1 1114 and 1126) and macrofauna size (from OR1 1096, 1102, 1114, 1126) seperatedly but and plot them together. This means that both meiofauna and macrofauna are in their raw abundance. These are same as the analyses of meiofauna_size.rmd and macrofauna_size.rmd.

```{r}
library(bbbs)
library(ggplot2)
library(plyr)
library(doBy)
library(readxl)
#library(devtools)
#install_github("andrew-edwards/sizeSpectra")
library(sizeSpectra)
library(viridis)

large <- theme(legend.title = element_text(size=20),
        legend.text = element_text(size=20),
        axis.title = element_text(size=20),
        axis.text = element_text(size=20))

rotate <- theme(axis.text.x = element_text(size=20, angle=60, hjust=0.5))
no_strip <- theme(strip.background = element_rect(colour=NA, fill=NA),
                  strip.text = element_text(colour=NA))
no_legend <- theme(legend.position = "none")

# dark theme for ggplot
dark <- theme(plot.background = element_rect(colour = 'NA', fill = 'gray10'),
        panel.background = element_rect(colour = 'NA', fill = 'transparent'),
        legend.background = element_rect(colour = 'NA', fill = 'transparent'),
        legend.title = element_text(colour = 'white', size=20),
        legend.text = element_text(colour = 'white', size=20),
        axis.title = element_text(colour = 'white', size=20),
        axis.text = element_text(colour = 'white', size=20),
        axis.ticks = element_line(colour = 'white'),
        panel.border = element_rect(fill = 'NA', colour = 'white'), 
        panel.grid.major = element_line(colour = 'gray30'),
        panel.grid.minor = element_line(colour = 'gray20'))
# log2 bin
l2b <- function(x) 2^( floor(log2(min(x))) : ceiling(log2(max(x))) )
```

# Construction of meiofauna and macrofauna size specturm

Normalized biomass size spectrum (NBSS) and individual size distribution (ISD) were computed using custom R package sizeSpectra (Edwards et al., 2017, Methods in Ecology and Evolution 1:57-67). A probability density function based on a bounded power law (PLB) distribution was fitted to the ISD of meiofauna or macrofauna using maximum likelihood estimation (MLE) to estimate the exponent b. The exponent b (determined by MLE) is equivalent to the regression slope of the NBSS; however, comparison studies by Edwards et al. (2017) concluded that MLE method is the most accurate way to estimate the slope of NBSS.

For normalized biomass size spectrum (NBSS), individual sizes of meiofauna or macrofauna were binned by log2 transformation of their biomass. The total biomass of each size bin was normalized by the width of the bin. The normalized biomass within each size bin was log10 transformed and then plotted against the log10 midpoint of the size bin. The slope of the NBSS was estimated from ISD based on PLB using maximum likelihood. The same fitted line (with 95% confidence interval) was plotted on the ISD, which ranks the body size in decreasing order to visualize the fit between the model and size data.

# NBSS and ISD by habitat

## All size classes

```{r, fig.width=8.1, fig.height=5}
# Use functions from Edwards etal. (2017) Methods in Ecology and Evolution 1:57-67
# https://github.com/andrew-edwards/fitting-size-spectra
#source("PLBfunctions.r")

bks <- l2b(c(mei_s$Wt, mac_s$Wt))

# Macrofauna
hab_mac <- splitBy(~Habitat, mac_s)
wt <- lapply(hab_mac, FUN=function(x)x$Wt)
out <- lapply(wt, FUN=function(x)LBNbiom.method(x, binBreaks=bks))
nbss <- ldply(lapply(out, FUN=function(x)x$binVals), data.frame)
info <- ldply(strsplit(nbss$.id, split="[|]"))
names(info) <- "Habitat"
nbss_mac <- cbind(info, nbss[, -1])

# Meiofauna
hab_mei <- splitBy(~Habitat, data=mei_s)
wt <- lapply(hab_mei, FUN=function(x)x$Wt)
out <- lapply(wt, FUN=function(x)LBNbiom.method(x, binBreaks=bks))
nbss <- ldply(lapply(out, FUN=function(x)x$binVals), data.frame)
info <- ldply(strsplit(nbss$.id, split="[|]"))
names(info) <- "Habitat"
nbss_mei <- cbind(info, nbss[, -1])

hab <- rbind(cbind(Class="Macro", ldply(hab_mac)[,c("Habitat", "Wt")]),
              cbind(Class="Meio", ldply(hab_mei)[,c("Habitat", "Wt")]))

nbss <- rbind(cbind(Class="Macro", nbss_mac),
              cbind(Class="Meio", nbss_mei))


ggplot(data=hab, 
       aes(x=log10(Wt), fill=Habitat, size=Class, linetype=Class))+
  geom_density(alpha=0.5)+
  scale_size_manual(values=c(1.5,1))+
  scale_fill_manual(values=c("#f1a340", "#998ec3"))+
  #scale_fill_viridis(discrete = TRUE)+
  labs(y="Frequency", x=expression(Log[10]~body~size~(mg)), fill="Benthos", size="Habitat")+
  #facet_wrap(~Class)+
  theme_bw() %+replace% large #%+replace% dark
```

Kernel density estimate of the log10 body size for meiofauna and macrofauna.  

```{r, fig.width=7, fig.height=5}
(f2a <- ggplot(data=nbss,aes(x=log10binMid, y=log10totalBiom, colour=Habitat, shape=Class))+
  geom_point(size=5, stroke=1.5)+
  geom_path(size=1)+
  scale_shape_manual(values=c(19, 1))+
  #scale_colour_manual(values=c("black", "gray"))+
  scale_colour_manual(values=c("#f1a340", "#998ec3"))+
  #scale_colour_viridis(discrete = TRUE)+
  labs(x=expression(Log[10]~"mid-point of"~size~class~(mg)), y=expression(Log[10]~biomass~(mg)), colour="Benthos")+
  theme_bw() %+replace% large #%+replace% dark
)
```

Biomass size spectrum for meiofauna and macrofauna. 

```{r, fig.width=7, fig.height=5}
(f2b <- ggplot(data=nbss, aes(x=log10binMid, y=log10totalBiomNorm, colour=Habitat, shape=Class))+
  geom_point(size=5, stroke=1.5)+
  geom_path(size=1)+
  scale_shape_manual(values=c(19, 1))+
  #scale_colour_manual(values=c("black", "gray"))+
  scale_colour_manual(values=c("#f1a340", "#998ec3"))+
  #scale_colour_viridis(discrete = TRUE)+
  labs(x=expression(Log[10]~"mid-point of"~size~class~(mg)), y=expression(Log[10]~normalized~biomass), colour="Benthos")+
  theme_bw() %+replace% large #%+replace% dark
)
```

Normalized biomass size spectrum for meiofauna and macrofauna. Unimodal shape indicates trophic structure or missing smallest and the largest individuals (sampling effect)?

## Macrofauna size classes > 1e-02 and meiofauna size classes > 1e-03

```{r}
# Macrofauna > 1e-02
hab <- splitBy(~Habitat, data=subset(mac_s, Wt> 1e-02))
wt <- lapply(hab, FUN=function(x)x$Wt)
out <- lapply(wt, FUN=function(x)LBNbiom.method(x, binBreaks=bks))
nbss2 <- ldply(lapply(out, FUN=function(x)x$binVals), data.frame)
info <- ldply(strsplit(nbss2$.id, split="[|]"))
names(info) <- "Habitat"
nbss2_mac <- cbind(info, nbss2[, -1])

out <- lapply(wt, FUN=MLE.method)
# size specutrum slope estimate by MLE
(macb <- lapply(out, FUN=function(x)x[1:2]%>%unlist)%>%ldply(.id="Habitat"))
plb <- ldply(lapply(out, FUN=function(x)x$PLB))
info <- ldply(strsplit(plb$.id, split="[|]"))
names(info) <- "Habitat"
plb_mac <- cbind(info, plb[, -1])

# Rank individual weight
SortWt <- lapply(hab, FUN=function(x)cbind(rank=1:length(x$Wt), weight=sort(x$Wt, decreasing=TRUE)))
SortWt <- ldply(SortWt)
info <- ldply(strsplit(SortWt$.id, split="[|]"))
names(info) <- "Habitat"
SortWt_mac <- cbind(info, SortWt[, -1])

# Slope meiofauna > 1e-03; canyon meiofauna > 0.5e-03
hab <- splitBy(~Habitat, data=subset(mei_s, (Habitat == "Slope" & Wt > 1e-03) | (Habitat == "Canyon" & Wt > 0.5e-03)))
wt <- lapply(hab, FUN=function(x)x$Wt)
out <- lapply(wt, FUN=function(x)LBNbiom.method(x, binBreaks=bks))
nbss2 <- ldply(lapply(out, FUN=function(x)x$binVals), data.frame)
info <- ldply(strsplit(nbss2$.id, split="[|]"))
names(info) <- "Habitat"
nbss2_mei <- cbind(info, nbss2[, -1])

out <- lapply(wt, FUN=MLE.method)
# size specutrum slope estimate by MLE
(meib <- lapply(out, FUN=function(x)x[1:2]%>%unlist)%>%ldply(.id="Habitat"))
plb <- ldply(lapply(out, FUN=function(x)x$PLB))
info <- ldply(strsplit(plb$.id, split="[|]"))
names(info) <- "Habitat"
plb_mei <- cbind(info, plb[, -1])

# Rank individual weight
SortWt <- lapply(hab, FUN=function(x)cbind(rank=1:length(x$Wt), weight=sort(x$Wt, decreasing=TRUE)))
SortWt <- ldply(SortWt)
info <- ldply(strsplit(SortWt$.id, split="[|]"))
names(info) <- "Habitat"
SortWt_mei <- cbind(info, SortWt[, -1])

nbss2 <- rbind(cbind(Class="Macro", nbss2_mac),
              cbind(Class="Meio", nbss2_mei))
plb <- rbind(cbind(Class="Macro", plb_mac),
              cbind(Class="Meio", plb_mei))
SortWt <- rbind(cbind(Class="Macro", SortWt_mac),
              cbind(Class="Meio", SortWt_mei))
```

```{r}
b <- rbind(cbind(Class="Meiofauna", meib), cbind(Class="Macrofauna", macb))
b$Class <- factor(b$Class, levels=c("Meiofauna", "Macrofauna"))
b$Habitat <- factor(b$Habitat, levels=c("Canyon", "Slope"))

ggplot(data=b, 
       aes(x=Habitat, y=PLB.bMLE, ymin=PLB.MLE.bConf1, ymax=PLB.MLE.bConf2, colour=Habitat, fill=Habitat))+
  geom_bar(stat = "identity")+
  geom_errorbar()+
  scale_colour_manual(values=c("#f1a340", "#998ec3"))+
  scale_fill_manual(values=c("#f1a340", "#998ec3"))+
  labs(y="NBSS Slope", x="")+
  scale_y_reverse()+
  facet_wrap(~Class)+
  theme_bw() %+replace% large #%+replace% dark
```

```{r, fig.width=7, fig.height=5}
(f2c <- ggplot(data=nbss2, aes(x=log10binMid, y=log10totalBiomNorm, colour=Habitat, shape=Class))+
  geom_point(size=5, stroke=1.5)+
  scale_colour_manual(values=c("#f1a340", "#998ec3"))+
  #scale_colour_viridis(discrete = TRUE)+
  scale_shape_manual(values=c(19, 1))+
  geom_path(data=plb, aes(x=log10(x.PLB), y=log10(B.PLB)))+
  geom_path(data=plb, aes(x=log10(x.PLB), y=log10(B.PLB.LC)), linetype=2)+
  geom_path(data=plb, aes(x=log10(x.PLB), y=log10(B.PLB.UC)), linetype=2)+
  labs(x=expression(Log[10]~"mid-point of"~size~class~(mg)), y=expression(Log[10]~normalized~biomass), colour="Benthos")+
  theme_bw() %+replace% large #%+replace% dark
)
```

Truncated normalized biomass size spectrum (NBSS) for meiofauna and macrofauna. The meiofauna with body size < 1e-03 mg, canyon meiofauna < 0.5e-03 mg, and macrofauna < 1e-02 mg were removed before fitting the NBSS using maximum likelihood method. The dashed lines indicate the lower and upper bounds of the 95% confidence interval of the fitted line. The canyon meiofauna have the steepest NBSS slope and the slope macrofauna have the most gradual NBSS slope, whereas the NBSS slope of the canyon macrofauna are similar the NBSS slope the slope meiofauna (due to overlapping confidence interval). 

```{r, fig.width=7, fig.height=5}
(f2d <- ggplot(data=SortWt, aes(x=weight, y=rank, colour=Habitat, shape=Class))+
  geom_point(size=2)+
  scale_colour_manual(values=c("#f1a340", "#998ec3"))+
  scale_shape_manual(values=c(19, 1))+
  geom_path(data=plb, aes(x=x.PLB, y=y.PLB))+
  geom_path(data=plb, aes(x=x.PLB, y=y.PLB.LC), linetype=2)+
  geom_path(data=plb, aes(x=x.PLB, y=y.PLB.UC), linetype=2)+
  scale_x_log10(expression(Log[10]~Individual~weight~(mg)), labels = function(x) log10(x))+
  scale_y_log10(expression(Log[10]~"Individual rank"), limits=c(1, NA), labels = function(x) log10(x))+
  labs(colour="Benthos")+
  theme_bw() %+replace% large #%+replace% dark
)
```

Turncated abundance size spectrum for meiofauna and macrofauna. The meiofauna with body size < 1e-03 mg, canyon meiofauna < 0.5e-03 mg, and macrofauna < 1e-02 mg were removed before fitting the NBSS using maximum likelihood method. The dashed lines indicate the lower and upper bounds of the 95% confidence interval of the fitted line.

```{r, fig.width=14, fig.height=10}
library(patchwork)

p1 <- f2a+labs(title="(A)")+no_legend
p2 <- f2b+labs(title="(B)")
p3 <- f2c+labs(title="(C)")+no_legend
p4 <- f2d+labs(title="(D)")+no_legend

(p1+p2)/(p3+p4)
```

## NBSS of all size classes but only fit larger individuals 

```{r, fig.width=7, fig.height=5}
ggplot(data=nbss, aes(x=log10binMid, y=log10totalBiomNorm, colour=Habitat, shape=Class))+
  geom_point(size=5, stroke=1.5)+
  scale_colour_manual(values=c("#f1a340", "#998ec3"))+
  #scale_colour_viridis(discrete = TRUE)+
  scale_shape_manual(values=c(19, 1))+
  geom_path(data=plb, aes(x=log10(x.PLB), y=log10(B.PLB)))+
  geom_path(data=plb, aes(x=log10(x.PLB), y=log10(B.PLB.LC)), linetype=2)+
  geom_path(data=plb, aes(x=log10(x.PLB), y=log10(B.PLB.UC)), linetype=2)+
  labs(x=expression(Log[10]~"mid-point of"~size~class~(mg)), y=expression(Log[10]~normalized~biomass), colour="Benthos")+
  theme_bw() %+replace% large #%+replace% dark
```

Normalized biomass-body size spectrum (NBSS) for meiofauna and macrofauna. Only the NBSS of meiofauna with body size > 1e-03 mg, canyon meiofauna > 0.5e-03 mg, and macrofauna > 1e-02 mg were fitted by maximum likelihood method. The dashed lines indicate the lower and upper bounds of the 95% confidence interval of the fitted line. 
