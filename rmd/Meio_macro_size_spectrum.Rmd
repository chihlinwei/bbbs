---
title: "Meiofauna + Macrofauna Size Spectrum"
author: "Chih-Lin Wei"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(bbbs)
library(ggplot2)
library(plyr)
library(doBy)

large <- theme(legend.title = element_text(size=20),
        legend.text = element_text(size=20),
        strip.text=element_text(size=20),
        axis.title = element_text(size=20),
        axis.text.y = element_text(size=20),
        axis.text.x = element_text(size=20, angle=60, hjust=0.5))

rotate <- theme(axis.text.x = element_text(size=20, angle=60, hjust=0.5))

# dark theme for ggplot
dark <- theme(plot.background = element_rect(colour = 'NA', fill = 'gray10'),
        panel.background = element_rect(colour = 'NA', fill = 'transparent'),
        legend.background = element_rect(colour = 'NA', fill = 'transparent'),
        legend.title = element_text(colour = 'white', size=20),
        legend.text = element_text(colour = 'white', size=20),
        axis.title = element_text(colour = 'white', size=20),
        axis.text = element_text(colour = 'white', size=20),
        axis.ticks = element_line(colour = 'white'),
        panel.border = element_rect(fill = 'NA', colour = 'white'), 
        panel.grid.major = element_line(colour = 'gray30'),
        panel.grid.minor = element_line(colour = 'gray20'))
```


# Construction of meiofauna + macrofauna size specturm

Normalized biomass size specturm (NBSS) and idividual size distribtion (ISD) were computed using custom R functions from Edwards et al. (2017, Methods in Ecology and Evolution 1:57-67). A probability density function based on a bounded power law (PLB) distribution was fitted to the ISD of meiofauna using maximum likelihood estimation (MLE) to estimate the exponent b. The exponent b (estimated by MLE) is equivalent to the reression slope of the NBSS; however, comparison studies by Edwards et al. (2017) concluded that MLE method is the most accurate way to estimate the slope. 

For normalized biomass size specturm (NBSS), individual size of macrofauna were binned by log2 transformation of their biomass. The total biomass of each bin was normalized by the width of the bin. The log10 normalized biomass was plotted against the log10 mid point of the size bin; however, the regression slope (and line) was not estimated from the NBSS. Instead, the slope (and line) was esimated by a customized probability density function using maximum likelyhood. 

The same fitted line (with 95% confidence interval) was plotted on the individual size distribution, which rank the body size in decresing order to visualized the fit between the model and size data. 

# NBSS and ISD by cruise and habitat

```{r, fig.width=7, fig.height=5}
# Use functions from Edwards etal. (2017) Methods in Ecology and Evolution 1:57-67
# https://github.com/andrew-edwards/fitting-size-spectra
source("PLBfunctions.r")

hab <- splitBy(~Cruise+Habitat, data=si)
wt <- lapply(hab, FUN=function(x)x$Wt)
out <- lapply(wt, FUN=LBNbiom.method)
nbss <- ldply(lapply(out, FUN=function(x)x$binVals), data.frame)
info <- ldply(strsplit(nbss$.id, split="[|]"))
names(info) <- c("Cruise", "Habitat")
nbss <- cbind(info, nbss[, -1])

#wt <- wt[unlist(lapply(wt, length))>9]
out <- lapply(wt, FUN=MLE.method)
# size specutrum slope estimate by MLE
lapply(out, FUN=function(x)x[1:2])
plb <- ldply(lapply(out, FUN=function(x)x$PLB))
info <- ldply(strsplit(plb$.id, split="[|]"))
names(info) <- c("Cruise", "Habitat")
plb <- cbind(info, plb[, -1])

ggplot(data=nbss, aes(x=log10binMid, y=log10totalBiomNorm, shape=Habitat, colour=Habitat))+
  geom_point(size=3)+
  scale_shape_manual(values=c(19,1))+
  geom_path(data=plb, aes(x=log10(x.PLB), y=log10(B.PLB)))+
  geom_path(data=plb, aes(x=log10(x.PLB), y=log10(B.PLB.LC)), linetype=2)+
  geom_path(data=plb, aes(x=log10(x.PLB), y=log10(B.PLB.UC)), linetype=2)+
  facet_wrap(~Cruise)+
  labs(x=expression(Log[10]~"mid-point of"~size~class~(mg)), y=expression(Log[10]~normalized~biomass))+
  theme_bw() %+replace% large %+replace% dark
```

```{r, fig.width=7, fig.height=5}
hab <- splitBy(~Cruise+Habitat, data=si)
wt <- lapply(hab, FUN=function(x)x$Wt)
# Remove the two smallest bins
wt <-lapply(wt, FUN=function(x){x <- x[x>1.144409e-05]; return(x)})
out <- lapply(wt, FUN=LBNbiom.method)
nbss <- ldply(lapply(out, FUN=function(x)x$binVals), data.frame)
info <- ldply(strsplit(nbss$.id, split="[|]"))
names(info) <- c("Cruise", "Habitat")
nbss <- cbind(info, nbss[, -1])

#wt <- wt[unlist(lapply(wt, length))>9]
out <- lapply(wt, FUN=MLE.method)
# size specutrum slope estimate by MLE
lapply(out, FUN=function(x)x[1:2])
plb <- ldply(lapply(out, FUN=function(x)x$PLB))
info <- ldply(strsplit(plb$.id, split="[|]"))
names(info) <- c("Cruise", "Habitat")
plb <- cbind(info, plb[, -1])

ggplot(data=nbss, aes(x=log10binMid, y=log10totalBiomNorm, shape=Habitat, colour=Habitat))+
  geom_point(size=3)+
  scale_shape_manual(values=c(19,1))+
  geom_path(data=plb, aes(x=log10(x.PLB), y=log10(B.PLB)))+
  geom_path(data=plb, aes(x=log10(x.PLB), y=log10(B.PLB.LC)), linetype=2)+
  geom_path(data=plb, aes(x=log10(x.PLB), y=log10(B.PLB.UC)), linetype=2)+
  facet_wrap(~Cruise)+
  labs(x=expression(Log[10]~"mid-point of"~size~class~(mg)), y=expression(Log[10]~normalized~biomass))+
  theme_bw() %+replace% large %+replace% dark
```

```{r, fig.width=10, fig.height=5}
# Rank individual weight
SortWt <- lapply(hab, FUN=function(x)cbind(rank=1:length(x$Wt), weight=sort(x$Wt, decreasing=TRUE)))
SortWt <- ldply(SortWt)
info <- ldply(strsplit(SortWt$.id, split="[|]"))
names(info) <- c("Cruise", "Habitat")
SortWt <- cbind(info, SortWt[, -1])

ggplot(data=SortWt, aes(x=weight, y=rank, shape=Habitat, colour=Habitat))+
  geom_point(size=2)+
  scale_shape_manual(values=c(19,1))+
  geom_path(data=plb, aes(x=x.PLB, y=y.PLB))+
  geom_path(data=plb, aes(x=x.PLB, y=y.PLB.LC), linetype=2)+
  geom_path(data=plb, aes(x=x.PLB, y=y.PLB.UC), linetype=2)+
  facet_wrap(~Cruise, scales="free")+
  scale_x_log10(expression(Individual~weight~(mg)), labels = function(x) format(x, scientific = T))+
  scale_y_log10("Individual rank", limits=c(1, NA), labels = function(x) format(x, scientific = T))+
  theme_bw() %+replace% large %+replace% dark
```

# NBSS and ISD by cruise and depth strata (or station)

```{r, fig.width=10, fig.height=5}
hab <- splitBy(~Cruise+Habitat+Depth.zone, data=si)
wt <- lapply(hab, FUN=function(x)x$Wt)
out <- lapply(wt, FUN=LBNbiom.method)
nbss <- ldply(lapply(out, FUN=function(x)x$binVals), data.frame)
info <- ldply(strsplit(nbss$.id, split="[|]"))
names(info) <- c("Cruise", "Habitat", "Depth")
nbss <- cbind(info, nbss[, -1])

#wt <- wt[unlist(lapply(wt, length))>9]
out <- lapply(wt, FUN=MLE.method)
# size specutrum slope estimate by MLE
lapply(out, FUN=function(x)x[1:2])
plb <- ldply(lapply(out, FUN=function(x)x$PLB))
info <- ldply(strsplit(plb$.id, split="[|]"))
names(info) <- c("Cruise", "Habitat", "Depth")
plb <- cbind(info, plb[, -1])

ggplot(data=nbss, aes(x=log10binMid, y=log10totalBiomNorm, shape=Habitat, colour=Habitat))+
  geom_point(size=3)+
  scale_shape_manual(values=c(19,1))+
  geom_path(data=plb, aes(x=log10(x.PLB), y=log10(B.PLB)))+
  geom_path(data=plb, aes(x=log10(x.PLB), y=log10(B.PLB.LC)), linetype=2)+
  geom_path(data=plb, aes(x=log10(x.PLB), y=log10(B.PLB.UC)), linetype=2)+
  facet_grid(Cruise~Depth)+
  labs(x=expression(Log[10]~"mid-point of"~size~class~(mg)), y=expression(Log[10]~normalized~biomass))+
  theme_bw() %+replace% large %+replace% dark
```

```{r, fig.width=10, fig.height=5}
hab <- splitBy(~Cruise+Habitat+Depth.zone, data=si)
wt <- lapply(hab, FUN=function(x)x$Wt)
# Remove the two smallest bins
wt <-lapply(wt, FUN=function(x){x <- x[x>1.144409e-05]; return(x)})
out <- lapply(wt, FUN=LBNbiom.method)
nbss <- ldply(lapply(out, FUN=function(x)x$binVals), data.frame)
info <- ldply(strsplit(nbss$.id, split="[|]"))
names(info) <- c("Cruise", "Habitat", "Depth")
nbss <- cbind(info, nbss[, -1])

#wt <- wt[unlist(lapply(wt, length))>9]
out <- lapply(wt, FUN=MLE.method)
# size specutrum slope estimate by MLE
lapply(out, FUN=function(x)x[1:2])
plb <- ldply(lapply(out, FUN=function(x)x$PLB))
info <- ldply(strsplit(plb$.id, split="[|]"))
names(info) <- c("Cruise", "Habitat", "Depth")
plb <- cbind(info, plb[, -1])

ggplot(data=nbss, aes(x=log10binMid, y=log10totalBiomNorm, shape=Habitat, colour=Habitat))+
  geom_point(size=3)+
  scale_shape_manual(values=c(19,1))+
  geom_path(data=plb, aes(x=log10(x.PLB), y=log10(B.PLB)))+
  geom_path(data=plb, aes(x=log10(x.PLB), y=log10(B.PLB.LC)), linetype=2)+
  geom_path(data=plb, aes(x=log10(x.PLB), y=log10(B.PLB.UC)), linetype=2)+
  facet_grid(Cruise~Depth)+
  labs(x=expression(Log[10]~"mid-point of"~size~class~(mg)), y=expression(Log[10]~normalized~biomass))+
  theme_bw() %+replace% large %+replace% dark
```

```{r, fig.width=10, fig.height=5}
# Rank individual weight
SortWt <- lapply(hab, FUN=function(x)cbind(rank=1:length(x$Wt), weight=sort(x$Wt, decreasing=TRUE)))
SortWt <- ldply(SortWt)
info <- ldply(strsplit(SortWt$.id, split="[|]"))
names(info) <- c("Cruise", "Habitat", "Depth")
SortWt <- cbind(info, SortWt[, -1])

ggplot(data=SortWt, aes(x=weight, y=rank, shape=Habitat, colour=Habitat))+
  geom_point(size=2)+
  scale_shape_manual(values=c(19,1))+
  geom_path(data=plb, aes(x=x.PLB, y=y.PLB))+
  geom_path(data=plb, aes(x=x.PLB, y=y.PLB.LC), linetype=2)+
  geom_path(data=plb, aes(x=x.PLB, y=y.PLB.UC), linetype=2)+
  facet_grid(Cruise~Depth)+
  scale_x_log10(expression(Individual~weight~(mg)), labels = function(x) format(x, scientific = T))+
  scale_y_log10("Individual rank", limits=c(1, NA), labels = function(x) format(x, scientific = T))+
  theme_bw() %+replace% large %+replace% dark
```

# NBSS and ISD by habitat and dominant taxa

```{r, fig.width=10, fig.height=5}
hab_pol <- splitBy(~Cruise+Habitat+Category, data=subset(si, Category=="Polychaeta" & (Cruise=="OR1_1096"|Cruise=="OR1_1114"|Cruise=="OR1_1126")))
hab_nem <- splitBy(~Cruise+Habitat+Category, data=subset(si, Category=="Nematoda" &  (Cruise=="OR1_1126"|Cruise=="OR1_1126")))
hab_har <- splitBy(~Cruise+Habitat+Category, data=subset(si, Category=="Harpacticoida" & (Cruise=="OR1_1096"|Cruise=="OR1_1102"|Cruise=="OR1_1114"|Cruise=="OR1_1126")))
hab <- rbind(ldply(hab_nem), ldply(hab_har), ldply(hab_pol))
hab <- splitBy(~Habitat+Category, hab)

wt <- lapply(hab, FUN=function(x)x$Wt)
out <- lapply(wt, FUN=LBNbiom.method)
nbss <- ldply(lapply(out, FUN=function(x)x$binVals), data.frame)
info <- ldply(strsplit(nbss$.id, split="[|]"))
names(info) <- c("Habitat", "Category")
nbss <- cbind(info, nbss[, -1])

wt <- wt[unlist(lapply(wt, length))>21]
out <- lapply(wt, FUN=MLE.method)
# size specutrum slope estimate by MLE
lapply(out, FUN=function(x)x[1:2])
plb <- ldply(lapply(out, FUN=function(x)x$PLB))
info <- ldply(strsplit(plb$.id, split="[|]"))
names(info) <- c("Habitat", "Category")
plb <- cbind(info, plb[, -1])

ggplot(data=nbss, aes(x=log10binMid, y=log10totalBiomNorm, shape=Habitat, colour=Habitat))+
  geom_point(size=3)+
  scale_shape_manual(values=c(19,1))+
  geom_path(data=plb, aes(x=log10(x.PLB), y=log10(B.PLB)))+
  geom_path(data=plb, aes(x=log10(x.PLB), y=log10(B.PLB.LC)), linetype=2)+
  geom_path(data=plb, aes(x=log10(x.PLB), y=log10(B.PLB.UC)), linetype=2)+
  facet_wrap(~Category, scales="free")+
  labs(x=expression(Log[10]~"mid-point of"~size~class~(mg)), y=expression(Log[10]~normalized~biomass))+
  theme_bw() %+replace% large %+replace% dark
```

```{r, fig.width=9, fig.height=5}
hab_pol <- splitBy(~Cruise+Habitat+Category, data=subset(si, Category=="Polychaeta" & (Cruise=="OR1_1096"|Cruise=="OR1_1114"|Cruise=="OR1_1126")))
hab_nem <- splitBy(~Cruise+Habitat+Category, data=subset(si, Category=="Nematoda" & (Cruise=="OR1_1114"|Cruise=="OR1_1126")))
hab_har <- splitBy(~Cruise+Habitat+Category, data=subset(si, Category=="Harpacticoida" & (Cruise=="OR1_1096"|Cruise=="OR1_1102"|Cruise=="OR1_1114"|Cruise=="OR1_1126")))

# Remove the two smallest bins
hab_pol <-lapply(hab_pol, FUN=function(x){x <- x[x$Wt>5.859375e-03,]; return(x)})
hab_nem <-lapply(hab_nem, FUN=function(x){x <- x[x$Wt>1.144409e-05,]; return(x)})

hab <- rbind(ldply(hab_nem), ldply(hab_har), ldply(hab_pol))
hab <- splitBy(~Habitat+Category, hab)

wt <- lapply(hab, FUN=function(x)x$Wt)
out <- lapply(wt, FUN=LBNbiom.method)
nbss <- ldply(lapply(out, FUN=function(x)x$binVals), data.frame)
info <- ldply(strsplit(nbss$.id, split="[|]"))
names(info) <- c("Habitat", "Category")
nbss <- cbind(info, nbss[, -1])

wt <- wt[unlist(lapply(wt, length))>21]
out <- lapply(wt, FUN=MLE.method)
# size specutrum slope estimate by MLE
lapply(out, FUN=function(x)x[1:2])
plb <- ldply(lapply(out, FUN=function(x)x$PLB))
info <- ldply(strsplit(plb$.id, split="[|]"))
names(info) <- c("Habitat", "Category")
plb <- cbind(info, plb[, -1])

ggplot(data=nbss, aes(x=log10binMid, y=log10totalBiomNorm, shape=Habitat, colour=Habitat))+
  geom_point(size=3)+
  scale_shape_manual(values=c(19,1))+
  geom_path(data=plb, aes(x=log10(x.PLB), y=log10(B.PLB)))+
  geom_path(data=plb, aes(x=log10(x.PLB), y=log10(B.PLB.LC)), linetype=2)+
  geom_path(data=plb, aes(x=log10(x.PLB), y=log10(B.PLB.UC)), linetype=2)+
  facet_wrap(~Category, scales="free")+
  labs(x=expression(Log[10]~"mid-point of"~size~class~(mg)), y=expression(Log[10]~normalized~biomass))+
  theme_bw() %+replace% large %+replace% dark
```

```{r, fig.width=10, fig.height=5}
# Rank individual weight
SortWt <- lapply(hab, FUN=function(x)cbind(rank=1:length(x$Wt), weight=sort(x$Wt, decreasing=TRUE)))
SortWt <- ldply(SortWt)
info <- ldply(strsplit(SortWt$.id, split="[|]"))
names(info) <- c("Habitat", "Category")
SortWt <- cbind(info, SortWt[, -1])

ggplot(data=SortWt, aes(x=weight, y=rank, shape=Habitat, colour=Habitat))+
  geom_point(size=2)+
  scale_shape_manual(values=c(19,1))+
  geom_path(data=plb, aes(x=x.PLB, y=y.PLB))+
  geom_path(data=plb, aes(x=x.PLB, y=y.PLB.LC), linetype=2)+
  geom_path(data=plb, aes(x=x.PLB, y=y.PLB.UC), linetype=2)+
  facet_wrap(~Category, scales="free_x")+
  scale_x_log10(expression(Individual~weight~(mg)), labels = function(x) format(x, scientific = T))+
  scale_y_log10("Individual rank", limits=c(1, NA), labels = function(x) format(x, scientific = T))+
  theme_bw() %+replace% large %+replace% dark
```
