---
title: "Meiofauna and Macrofauna Size Spectrum"
author: "Chih-Lin Wei"
date: "`r Sys.Date()`"
output: 
  html_document:
    toc: true # table of content true
    toc_depth: 3  # upto three depths of headings (specified by #, ## and ###) 
    toc_float: true
    number_sections: true  ## if you want number sections at each table header
    theme: united  # many options for theme, this one is my favorite.
    highlight: tango  # specifies the syntax highlighting style
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
```

```{r}
library(bbbs)
library(ggplot2)
library(ggrepel)
library(plyr)
library(doBy)
library(readxl)
library(reshape2)
library(vegan)
library(RColorBrewer)
library(metR)
library(knitr)


large <- theme(legend.title = element_text(size=20),
        legend.text = element_text(size=20),
        axis.title = element_text(size=20),
        axis.text = element_text(size=20))

rotate <- theme(axis.text.x = element_text(size=20, angle=60, hjust=0.5))

# dark theme for ggplot
dark <- theme(plot.background = element_rect(colour = 'NA', fill = 'gray10'),
        panel.background = element_rect(colour = 'NA', fill = 'transparent'),
        legend.background = element_rect(colour = 'NA', fill = 'transparent'),
        legend.title = element_text(colour = 'white', size=20),
        legend.text = element_text(colour = 'white', size=20),
        axis.title = element_text(colour = 'white', size=20),
        axis.text = element_text(colour = 'white', size=20),
        axis.ticks = element_line(colour = 'white'),
        panel.border = element_rect(fill = 'NA', colour = 'white'), 
        panel.grid.major = element_line(colour = 'gray30'),
        panel.grid.minor = element_line(colour = 'gray20'))

jet.colors <-
  colorRampPalette(c("#00007F", "blue", "#007FFF", "cyan",
                     "#7FFF7F", "yellow", "#FF7F00", "red", "#7F0000"))

# log2 bin
l2b <- function(x) 2^( floor(log2(min(x))) : ceiling(log2(max(x))) )

bks <- l2b(c(mei_s$Wt, mac_s$Wt))
```

Individual size of meiofauna and macrofauna were binned by log2 transformation of their biomass. The total biomass of each size bin and each sample was than calculated as size composition for further multivariate analysis. 

# Meiofauna size composition
## Per sample

```{r, fig.width=8.1, fig.height=5}
mei_s$Class <- cut(mei_s$Wt, breaks=bks, labels=log10((bks[-28]+bks[-1])/2) %>% round(digits = 1)) 

mei_sc <- acast(mei_s, Cruise+Habitat+Station+Deployment+Tube+Subcore+Depth~Class, value.var = "Wt", fun.aggregate=sum)
fr <- strsplit(row.names(mei_sc), split="_") %>%ldply
fr <- cbind(paste(fr$V1, fr$V2, sep="_"), fr[,-1:-2])
names(fr) <- c("Cruise", "Habitat", "Station", "Deployment", "Tube", "Subcore", "Depth")
fr$Depth <- as.numeric(fr$Depth)


# nMDS
mei_md <- metaMDS(mei_sc, distance = "bray")
stress <- paste("Stress = ", deparse(round(mei_md$stress,2)))

# Weighted Averages Scores
mei_wa <- wascores(mei_md$points, mei_sc) %>% as.data.frame
mei_wa$label <- row.names(mei_wa) %>% as.numeric

ggplot(data=cbind(mei_md$points, fr), aes(x=MDS1, y=MDS2, fill=Habitat, colour=Habitat))+
  stat_ellipse(type="norm", geom="polygon", alpha=0.2, colour="transparent")+
  geom_point(pch=21, alpha=0.8, size=5, colour=gray(0, 0.2))+
  #geom_point(data=cbind(mei_md$points, fr) %>% subset(Cruise=="OR1_1114"), pch=21, size=2, fill="white", colour="black")+
  annotate("text", x=-2, y=1.5, label=stress, size=5) +
  geom_label_repel(data=mei_wa, aes(x=MDS1, y=MDS2, label=label), colour="black", 
             fill=gray(1, 0.6), size=4, label.padding = unit(0.2, "lines"), parse = TRUE)+
  theme_bw() %+replace% large
```

nMDS on size composition of meiofauna. Labels show the weighted averages scores for each size class and the text inside label indicates the log10 of the mid point of the size class.

```{r}
# ordisurf:
mei_or <- ordisurf(mei_wa[,-3], mei_wa$label, plot = FALSE)
summary(mei_or)
mei_gr <- expand.grid(x = mei_or$grid$x, y = mei_or$grid$y) #get x and ys
mei_gr$z <- as.vector(mei_or$grid$z) #unravel the matrix for the z scores
mei_gr <- data.frame(na.omit(mei_gr)) #gets rid of the nas

# Predict ordisurf
newdata <- expand.grid(x1=seq(min(mei_md$points[,1]),  max(mei_md$points[,1]), len = 10), x2= seq(min(mei_md$points[,2]),  max(mei_md$points[,2]), len=10))
mei_gr2 <- cbind(newdata, z= predict(mei_or, newdata))
names(mei_gr2) <- c("x", "y", "z")
```

```{r, fig.width=8.1, fig.height=5}
ggplot()+
  stat_ellipse(data=cbind(mei_md$points, fr), geom = "polygon", aes(x=MDS1, y=MDS2, fill=Habitat), alpha = 0.2, type="norm")+
  stat_contour(data = mei_gr2, aes(x = x, y = y, z = z, colour=..level..), binwidth = 0.5)+
  geom_text_contour(data = mei_gr2, aes(x = x, y = y, z = z), colour="#08306b")+
  geom_point(data=cbind(mei_md$points, fr), aes(x=MDS1, y=MDS2, fill=Habitat, colour=Habitat), pch=21, alpha=0.8, size=5, colour=gray(0, 0.2))+
  labs(x="MDS1", y="MDS2", colour="Size")+
  annotate("text", x=-2, y=1.5, label=stress, size=5)+
  theme_bw() %+replace% large
```

nMDS on size composition of meiofauna. Contours show the weighted averages scores for each size class. The text on the contours and color scale indicate the log10 of the mid point of the size class.

## Per station

```{r}
mei_sc2 <- acast(mei_s, Cruise+Habitat+Station+Depth~Class, value.var = "Wt", fun.aggregate=mean, na.rm=TRUE)
mei_sc2[is.na(mei_sc2)] <- 0
fr <- strsplit(row.names(mei_sc2), split="_") %>%ldply
fr <- cbind(paste(fr$V1, fr$V2, sep="_"), fr[,-1:-2])
names(fr) <- c("Cruise", "Habitat", "Station", "Depth")
fr$Depth <- as.numeric(fr$Depth)

# Main effect
f <- adonis(mei_sc2~Habitat+Cruise+Depth+Habitat:Depth+Habitat:Cruise+Depth:Cruise, data=fr, method="bray")
kable(f$aov.tab)
```

# Macrofauna size composition
## Per sample

```{r, fig.width=8.1, fig.height=5}
mac_s$Class <- cut(mac_s$Wt, breaks=bks, labels=log10((bks[-28]+bks[-1])/2) %>% round(digits = 1))

mac_sc <- acast(mac_s, Cruise+Habitat+Station+Deployment+Tube~Class, value.var = "Wt", fun.aggregate=sum)[-39,]
fr <- strsplit(row.names(mac_sc), split="_") %>%ldply
fr <- cbind(paste(fr$V1, fr$V2, sep="_"), fr[,-1:-2])
names(fr) <- c("Cruise", "Habitat", "Station", "Deployment", "Tube")

# nMDS
mac_md <- metaMDS(mac_sc, distance = "bray")
stress <- paste("Stress = ", deparse(round(mac_md$stress,2)))

# Weighted Averages Scores
mac_wa <- wascores(mac_md$points, mac_sc, expand = TRUE) %>% as.data.frame
mac_wa$label <- row.names(mac_wa) %>% as.numeric


ggplot(data=cbind(mac_md$points, fr), aes(x=MDS1, y=MDS2, fill=Habitat, colour=Habitat))+
  stat_ellipse(type="norm", geom="polygon", alpha=0.2, colour="transparent")+
  geom_point(pch=21, alpha=0.8, size=5, colour=gray(0, 0.2))+
  #geom_point(data=cbind(mac_md$points, fr) %>% subset(Cruise=="OR1_1114"), pch=21, size=2, fill="white", colour="black")+
  annotate("text", x=-1.2, y=1.2, label=stress, size=5) +
  geom_label_repel(data=mac_wa, aes(x=MDS1, y=MDS2, label=label), colour="black", 
             fill=gray(1, 0.6), size=4, label.padding = unit(0.2, "lines"), parse = TRUE)+
  theme_bw() %+replace% large
```

nMDS on size composition of macrofauna. Labels show the weighted averages scores for each size class and the text inside label indicates the log10 of the mid point of the size class.

```{r}
# ordisurf:
mac_or <- ordisurf(mac_wa[,-3], mac_wa$labe, plot=FALSE)
summary(mac_or)
mac_gr <- expand.grid(x = mac_or$grid$x, y = mac_or$grid$y) #get x and ys
mac_gr$z <- as.vector(mac_or$grid$z) #unravel the matrix for the z scores
mac_gr <- data.frame(na.omit(mac_gr)) #gets rid of the nas

# Predict ordisurf
newdata <- expand.grid(x1=seq(min(mac_md$points[,1]),  max(mac_md$points[,1]), len = 10), x2= seq(min(mac_md$points[,2]),  max(mac_md$points[,2]), len=10))
mac_gr2 <- cbind(newdata, z= predict(mac_or, newdata))
names(mac_gr2) <- c("x", "y", "z")
```

```{r, fig.width=8.1, fig.height=5}
ggplot()+
  stat_ellipse(data=cbind(mac_md$points, fr), geom = "polygon", aes(x=MDS1, y=MDS2, fill=Habitat), alpha = 0.2, type="norm")+
  #stat_contour(data = mac_gr, aes(x = x, y = y, z = z, colour=..level..))+
  #geom_text_contour(data = mac_gr, aes(x = x, y = y, z = z), colour="#08306b")+
  geom_point(data=cbind(mac_md$points, fr), aes(x=MDS1, y=MDS2, fill=Habitat, colour=Habitat), pch=21, alpha=0.8, size=5, colour=gray(0, 0.2))+
  labs(x="MDS1", y="MDS2", colour="Size")+
  annotate("text", x=-1.2, y=1.2, label=stress, size=5) +
  theme_bw() %+replace% large
```

nMDS on size composition of meiofauna.

## Per satation

```{r}
mac_sc2 <- acast(mac_s, Cruise+Habitat+Station+Depth~Class, value.var = "Wt", fun.aggregate=mean, na.rm=TRUE)
mac_sc2[is.na(mac_sc2)] <- 0
fr <- strsplit(row.names(mac_sc2), split="_") %>%ldply
fr <- cbind(paste(fr$V1, fr$V2, sep="_"), fr[,-1:-2])
names(fr) <- c("Cruise", "Habitat", "Station", "Depth")
fr$Depth <- as.numeric(fr$Depth)

# Main effect
f <- adonis(mac_sc2~Habitat+Cruise+Depth+Habitat:Depth+Habitat:Cruise+Depth:Cruise, data=fr, method="bray")
kable(f$aov.tab)
```
