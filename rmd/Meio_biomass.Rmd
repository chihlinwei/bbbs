---
title: "Meiofauna biomass"
author: "Chih-Lin Wei"
date: "`r Sys.Date()`"
output: 
  html_document:
    toc: true # table of content true
    toc_depth: 3  # upto three depths of headings (specified by #, ## and ###) 
    toc_float: true
    number_sections: true  ## if you want number sections at each table header
    theme: united  # many options for theme, this one is my favorite.
    highlight: tango  # specifies the syntax highlighting style
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE)
```

```{r}
library(ggplot2)
library(plyr)
library(doBy)
library(readxl)
library(knitr)

large <- theme(legend.title = element_text(size=20),
        legend.text = element_text(size=20),
        axis.title = element_text(size=20),
        axis.text = element_text(size=20))
```

# Totoal density
## By cruise
```{r, fig.width=7, fig.height=5}
# Sorting data
mei_a   <- read_excel("../excel/GPSC_meio_sorting_2016.08.18.xlsx", sheet=2)
mei_a <- summaryBy(Abundance~Cruise+Station+Station+Deployment+Tube+Subcore, data=as.data.frame(mei_a), FUN=sum, keep.names=T)
mei_a$Density <- mei_a$Abundance/(pi*(2.5/2)^2/10000)
mei_a <- summaryBy(Density~Cruise+Station, data=mei_a, FUN=c(mean, sd, length), keep.names = TRUE)
mei_a$Density.se <- mei_a$Density.sd/mei_a$Density.length^0.5
cord   <- read_excel("../excel/GPSC_meio_sorting_2016.08.18.xlsx", sheet=1)
keep <- match(paste(mei_a$Cruise, mei_a$Station), paste(cord$Cruise, cord$Station))
out<- cbind(cord[keep, 3:9], mei_a[, 3:6])
names(out)[8:11] <- c("Density", "sd", "n", "se")

ggplot(data= out, 
       aes(x=Depth, y=(Density), ymin=(Density-se), ymax=(Density+se), colour=Habitat, fill=Habitat))+
  geom_point(size=5)+
  scale_shape_manual(values=c(19,1))+
  geom_errorbar()+
  stat_smooth(method="lm", formula=y~x, alpha=0.2)+
  scale_colour_manual(values=c("black","gray"))+
  scale_fill_manual(values=c("black","gray"))+
  scale_linetype_manual(values=c(1,2))+
  labs(x="Depth (m)", y=expression(Density~(Indiv~m^-2)))+
  scale_y_log10()+
  theme_bw() %+replace% large

out$Longitude <- round(out$Longitude, 4)
out$Latitude <- round(out$Latitude, 4)
out$Depth <- round(out$Depth, 0)
out$Density <- round(out$Density, 0)
out$sd <- round(out$sd, 1)
out$se <- round(out$se, 1)
kable(out, align="c")
```

## Per station

```{r}
out <- summaryBy(Longitude+Latitude+Depth+Density~Habitat+Station, data=out, FUN=mean, keep.names = TRUE)

ggplot(data= out, 
       aes(x=Depth, y=Density, colour=Habitat))+
  geom_point(size=5)+
  scale_shape_manual(values=c(19,1))+
  stat_smooth(method="lm", formula=y~x, alpha=0.2)+
  scale_linetype_manual(values=c(1,2))+
  labs(x="Depth (m)", y=expression(Density~(Indiv~m^-2)))+
  scale_y_log10()+
  theme_bw() %+replace% large

kable(out)
```

# Totoal biomass
## Per cruise
```{r}
out <- summaryBy(Wt~Cruise+Station+Deployment+Tube+Subcore, data=mei_s, FUN=sum, keep.names = TRUE)
out <- summaryBy(Wt~Cruise+Station, data=out, FUN=c(mean, sd), keep.names = TRUE)
out$Biomass <- out$Wt.mean/(pi*(2.5/2)^2/10000)
out$sd <- out$Wt.sd/(pi*(2.5/2)^2/10000)
keep <- match(paste(out$Cruise, out$Station), paste(cord$Cruise, cord$Station))
out <- cbind(cord[keep, 3:9], out[, 5:6])

ggplot(data= out, 
       aes(x=Depth, y=Biomass, ymin=(Biomass-sd), ymax=(Biomass+sd), colour=Habitat))+
  geom_point(size=5)+
  scale_shape_manual(values=c(19,1))+
  geom_errorbar()+
  stat_smooth(method="lm", formula=y~x, alpha=0.2)+
  scale_linetype_manual(values=c(1,2))+
  labs(x="Depth (m)", y=expression(Biomass~(mg~m^-2)))+
  scale_y_log10()+
  theme_bw() %+replace% large

kable(out)
```

## Per station

```{r}
out <- summaryBy(Longitude+Latitude+Depth+Biomass~Habitat+Station, data=out, FUN=mean, keep.names = TRUE)

ggplot(data= out, 
       aes(x=Depth, y=Biomass, colour=Habitat))+
  geom_point(size=5)+
  scale_shape_manual(values=c(19,1))+
  stat_smooth(method="lm", formula=y~x, alpha=0.2)+
  scale_linetype_manual(values=c(1,2))+
  labs(x="Depth (m)", y=expression(Biomass~(mg~m^-2)))+
  scale_y_log10()+
  theme_bw() %+replace% large

kable(out)
```
