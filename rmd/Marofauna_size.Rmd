---
title: "Macrofauna Size Spectrum & Biomass for OR1 1096, 1102, 1114, 1126"
author: "Chih-Lin Wei"
date: "`r Sys.Date()`"
output: 
  html_document:
    toc: true # table of content true
    toc_depth: 3  # upto three depths of headings (specified by #, ## and ###) 
    toc_float: true
    number_sections: true  ## if you want number sections at each table header
    theme: united  # many options for theme, this one is my favorite.
    highlight: tango  # specifies the syntax highlighting style
---
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE)
```

```{r}
library(bbbs)
library(ggplot2)
library(plyr)
library(doBy)
library(readxl)
#library(devtools)
#install_github("andrew-edwards/sizeSpectra")
library(sizeSpectra)

large <- theme(legend.title = element_text(size=20),
        legend.text = element_text(size=20),
        axis.title = element_text(size=20),
        axis.text = element_text(size=20))

rotate <- theme(axis.text.x = element_text(size=20, angle=60, hjust=0.5))

# dark theme for ggplot
dark <- theme(plot.background = element_rect(colour = 'NA', fill = 'gray10'),
        panel.background = element_rect(colour = 'NA', fill = 'transparent'),
        legend.background = element_rect(colour = 'NA', fill = 'transparent'),
        legend.title = element_text(colour = 'white', size=20),
        legend.text = element_text(colour = 'white', size=20),
        axis.title = element_text(colour = 'white', size=20),
        axis.text = element_text(colour = 'white', size=20),
        axis.ticks = element_line(colour = 'white'),
        panel.border = element_rect(fill = 'NA', colour = 'white'), 
        panel.grid.major = element_line(colour = 'gray30'),
        panel.grid.minor = element_line(colour = 'gray20'))
# log2 bin
l2b <- function(x) 2^( floor(log2(min(x))) : ceiling(log2(max(x))) )
```

# Construction of macrofauna size specturm

Normalized biomass size spectrum (NBSS) and individual size distribution (ISD) were computed using R package sizeSpectra (Edwards et al., 2017, Methods in Ecology and Evolution 1:57-67). A probability density function based on a bounded power law (PLB) distribution was fitted to the ISD of macrofauna using maximum likelihood estimation (MLE) to estimate the exponent b. The exponent b (determined by MLE) is equivalent to the regression slope of the NBSS; however, comparison studies by Edwards et al. (2017) concluded that MLE method is the most accurate way to estimate the slope. 

For normalized biomass size spectrum (NBSS), individual size of macrofauna were binned by log2 transformation of their biomass. The total biomass of each bin was normalized by the width of the bin. The log10 normalized biomass was plotted against the log10 midpoint of the size bin; however, the regression slope (and line) was not estimated from the NBSS. Instead, the slope (and line) was estimated by a customized probability density function using maximum likelihood. 

The same fitted line (with 95% confidence interval) was plotted on the individual size distribution, which ranks the body size in decreasing order to visualized the fit between the model and size data. 

# NBSS and ISD by habitat
## All size classes

```{r, fig.width=7, fig.height=5}
# Use functions from Edwards etal. (2017) Methods in Ecology and Evolution 1:57-67
# https://github.com/andrew-edwards/fitting-size-spectra
#source("PLBfunctions.r")

hab <- splitBy(~Habitat, data=subset(mac_s, Condition=="C"))
wt <- lapply(hab, FUN=function(x)x$Wt)
bks <- l2b(unlist(wt))
out <- lapply(wt, FUN=function(x)LBNbiom.method(x, binBreaks=bks))
nbss <- ldply(lapply(out, FUN=function(x)x$binVals), data.frame)
info <- ldply(strsplit(nbss$.id, split="[|]"))
names(info) <- c("Habitat")
nbss <- cbind(info, nbss[, -1])

ggplot(data=ldply(hab), 
       aes(x=log10(Wt), fill=Habitat))+
  geom_density(alpha=0.5)+
  scale_fill_manual(values=c("black", "gray"))+
  labs(y="Frequency", x=expression(Log[10]~body~size~(mg)))+
  theme_bw() %+replace% large #%+replace% dark

ggplot(data=nbss,aes(x=log10binMid, y=log10totalBiom, colour=Habitat))+
  geom_point(size=5)+
  geom_path(size=1)+
  scale_colour_manual(values=c("black","gray"))+
  labs(x=expression(Log[10]~"mid-point of"~size~class~(mg)), y=expression(Log[10]~biomass~(mg~m^-2)))+
  theme_bw() %+replace% large #%+replace% dark

ggplot(data=nbss,aes(x=log10binMid, y=log10totalBiomNorm, colour=Habitat))+
  geom_point(size=5)+
  geom_path(size=1)+
  scale_colour_manual(values=c("black","gray"))+
  labs(x=expression(Log[10]~"mid-point of"~size~class~(mg)), y=expression(Log[10]~normalized~biomass))+
  theme_bw() %+replace% large #%+replace% dark
```

## Size classes > 7.812500e-03

```{r, fig.width=7, fig.height=5}
# Only keep Wt > 7.812500e-03

hab <- splitBy(~Habitat, data=subset(mac_s, Condition=="C" &Wt>7.812500e-03))
wt <- lapply(hab, FUN=function(x)x$Wt)
out <- lapply(wt, FUN=function(x)LBNbiom.method(x, binBreaks=bks))
nbss <- ldply(lapply(out, FUN=function(x)x$binVals), data.frame)
info <- ldply(strsplit(nbss$.id, split="[|]"))
names(info) <- c("Habitat")
nbss <- cbind(info, nbss[, -1])

out <- lapply(wt, FUN=MLE.method)
# size specutrum slope estimate by MLE
lapply(out, FUN=function(x)x[1:2])
plb <- ldply(lapply(out, FUN=function(x)x$PLB))
info <- ldply(strsplit(plb$.id, split="[|]"))
names(info) <- c("Habitat")
plb <- cbind(info, plb[, -1])

ggplot(data=ldply(hab), 
       aes(x=log10(Wt), fill=Habitat))+
  geom_density(alpha=0.5)+
  scale_fill_manual(values=c("black", "gray"))+
  labs(y="Frequency", x=expression(Log[10]~body~size~(mg)))+
  theme_bw() %+replace% large #%+replace% dark

ggplot(data=nbss,aes(x=log10binMid, y=log10totalBiomNorm, colour=Habitat))+
  geom_point(size=5)+
  geom_path(data=plb, aes(x=log10(x.PLB), y=log10(B.PLB)))+
  geom_path(data=plb, aes(x=log10(x.PLB), y=log10(B.PLB.LC)), linetype=2)+
  geom_path(data=plb, aes(x=log10(x.PLB), y=log10(B.PLB.UC)), linetype=2)+
  scale_colour_manual(values=c("black","gray"))+
  labs(x=expression(Log[10]~"mid-point of"~size~class~(mg)), y=expression(Log[10]~normalized~biomass))+
  theme_bw() %+replace% large #%+replace% dark

# Rank individual weight
SortWt <- lapply(hab, FUN=function(x)cbind(rank=1:length(x$Wt), weight=sort(x$Wt, decreasing=TRUE)))
SortWt <- ldply(SortWt)
info <- ldply(strsplit(SortWt$.id, split="[|]"))
names(info) <- c("Habitat")
SortWt <- cbind(info, SortWt[, -1])

ggplot(data=SortWt, aes(x=weight, y=rank, colour=Habitat))+
  geom_point(size=3)+
  geom_path(data=plb, aes(x=x.PLB, y=y.PLB))+
  geom_path(data=plb, aes(x=x.PLB, y=y.PLB.LC), linetype=2)+
  geom_path(data=plb, aes(x=x.PLB, y=y.PLB.UC), linetype=2)+
  scale_colour_manual(values=c("black","gray"))+
  scale_x_log10(expression(Individual~weight~(mg)))+
  scale_y_log10("Individual rank", limits=c(1, NA))+
  theme_bw() %+replace% large %+replace% rotate #%+replace% dark 
```

# NBSS and ISD by cruise and habitat
## All size classes

```{r, fig.width=10, fig.height=8}

hab <- splitBy(~Cruise+Habitat, data=subset(mac_s, Condition=="C"))
wt <- lapply(hab, FUN=function(x)x$Wt)
out <- lapply(wt, FUN=function(x)LBNbiom.method(x, binBreaks=bks))
nbss <- ldply(lapply(out, FUN=function(x)x$binVals), data.frame)
info <- ldply(strsplit(nbss$.id, split="[|]"))
names(info) <- c("Cruise", "Habitat")
nbss <- cbind(info, nbss[, -1])

ggplot(data=ldply(hab), 
       aes(x=log10(Wt), fill=Habitat))+
  geom_density(alpha=0.5)+
  scale_fill_manual(values=c("black", "gray"))+
  facet_wrap(~Cruise, scales="free")+
  labs(y="Frequency", x=expression(Log[10]~body~size~(mg)))+
  theme_bw() %+replace% large #%+replace% dark

ggplot(data=nbss,aes(x=log10binMid, y=log10totalBiom, colour=Habitat))+
  geom_point(size=5)+
  geom_path(size=1)+
  facet_wrap(~Cruise, scales="free")+
  scale_colour_manual(values=c("black","gray"))+
  labs(x=expression(Log[10]~"mid-point of"~size~class~(mg)), y=expression(Log[10]~biomass~(mg~m^-2)))+
  theme_bw() %+replace% large #%+replace% dark

ggplot(data=nbss,aes(x=log10binMid, y=log10totalBiomNorm, colour=Habitat))+
  geom_point(size=5)+
  geom_path(size=1)+
  facet_wrap(~Cruise, scales="free")+
  scale_colour_manual(values=c("black","gray"))+
  labs(x=expression(Log[10]~"mid-point of"~size~class~(mg)), y=expression(Log[10]~normalized~biomass))+
  theme_bw() %+replace% large #%+replace% dark
```

## Size classes > 7.812500e-03

```{r, fig.width=10, fig.height=8}
# Only keep Wt > 7.812500e-03

hab <- splitBy(~Cruise+Habitat, data=subset(mac_s, Condition=="C" & Wt>7.812500e-03))
wt <- lapply(hab, FUN=function(x)x$Wt)
out <- lapply(wt, FUN=function(x)LBNbiom.method(x, binBreaks=bks))
nbss <- ldply(lapply(out, FUN=function(x)x$binVals), data.frame)
info <- ldply(strsplit(nbss$.id, split="[|]"))
names(info) <- c("Cruise", "Habitat")
nbss <- cbind(info, nbss[, -1])

out <- lapply(wt, FUN=MLE.method)
# size specutrum slope estimate by MLE
lapply(out, FUN=function(x)x[1:2])
plb <- ldply(lapply(out, FUN=function(x)x$PLB))
info <- ldply(strsplit(plb$.id, split="[|]"))
names(info) <- c("Cruise", "Habitat")
plb <- cbind(info, plb[, -1])

ggplot(data=ldply(hab), 
       aes(x=log10(Wt), fill=Habitat))+
  geom_density(alpha=0.5)+
  scale_fill_manual(values=c("black", "gray"))+
  facet_wrap(~Cruise, scales="free")+
  labs(y="Frequency", x=expression(Log[10]~body~size~(mg)))+
  theme_bw() %+replace% large #%+replace% dark

ggplot(data=nbss,aes(x=log10binMid, y=log10totalBiomNorm, colour=Habitat))+
  geom_point(size=5)+
  geom_path(data=plb, aes(x=log10(x.PLB), y=log10(B.PLB)))+
  geom_path(data=plb, aes(x=log10(x.PLB), y=log10(B.PLB.LC)), linetype=2)+
  geom_path(data=plb, aes(x=log10(x.PLB), y=log10(B.PLB.UC)), linetype=2)+
  facet_wrap(~Cruise, scales="free")+
  scale_colour_manual(values=c("black","gray"))+
  labs(x=expression(Log[10]~"mid-point of"~size~class~(mg)), y=expression(Log[10]~normalized~biomass))+
  theme_bw() %+replace% large #%+replace% dark

# Rank individual weight
SortWt <- lapply(hab, FUN=function(x)cbind(rank=1:length(x$Wt), weight=sort(x$Wt, decreasing=TRUE)))
SortWt <- ldply(SortWt)
info <- ldply(strsplit(SortWt$.id, split="[|]"))
names(info) <- c("Cruise", "Habitat")
SortWt <- cbind(info, SortWt[, -1])

ggplot(data=SortWt, aes(x=weight, y=rank, colour=Habitat))+
  geom_point(size=3)+
  geom_path(data=plb, aes(x=x.PLB, y=y.PLB))+
  geom_path(data=plb, aes(x=x.PLB, y=y.PLB.LC), linetype=2)+
  geom_path(data=plb, aes(x=x.PLB, y=y.PLB.UC), linetype=2)+
  scale_colour_manual(values=c("black","gray"))+
  facet_wrap(~Cruise, scales="free")+
  scale_x_log10(expression(Individual~weight~(mg)))+
  scale_y_log10("Individual rank", limits=c(1, NA))+
  theme_bw() %+replace% large %+replace% rotate #%+replace% dark 
```

# NBSS and ISD by habitat and depth strata
## All size classes

```{r, fig.width=8, fig.height=6}
hab <- splitBy(~Habitat+Depth.zone, data=subset(mac_s, Condition=="C"))
wt <- lapply(hab, FUN=function(x)x$Wt)
out <- lapply(wt, FUN=function(x)LBNbiom.method(x, binBreaks=bks))
nbss <- ldply(lapply(out, FUN=function(x)x$binVals), data.frame)
info <- ldply(strsplit(nbss$.id, split="[|]"))
names(info) <- c("Habitat", "Depth")
nbss <- cbind(info, nbss[, -1])

ggplot(data=ldply(hab), 
       aes(x=log10(Wt), fill=Habitat))+
  geom_density(alpha=0.5)+
  scale_fill_manual(values=c("black", "gray"))+
  facet_wrap(~Depth.zone, scales="free")+
  labs(y="Frequency", x=expression(Log[10]~body~size~(mg)))+
  theme_bw() %+replace% large #%+replace% dark

ggplot(data=nbss, aes(x=log10binMid, y=log10totalBiom, colour=Habitat))+
  geom_point(size=3)+
  geom_path(size=1)+
  scale_colour_manual(values=c("black","gray"))+
  facet_wrap(~Depth, scales="free")+
  labs(x=expression(Log[10]~"mid-point of"~size~class~(mg)), y=expression(Log[10]~biomass~(mg~m^-2)))+
  theme_bw()%+replace% large #%+replace% dark

ggplot(data=nbss, aes(x=log10binMid, y=log10totalBiomNorm, colour=Habitat))+
  geom_point(size=3)+
  geom_path(size=1)+
  scale_colour_manual(values=c("black","gray"))+
  facet_wrap(~Depth, scales="free")+
  labs(x=expression(Log[10]~"mid-point of"~size~class~(mg)), y=expression(Log[10]~normalized~biomass))+
  theme_bw()%+replace% large #%+replace% dark
```

## Size classes > 7.812500e-03

```{r, fig.width=8, fig.height=6}
# Only keep Wt >7.812500e-03

hab <- splitBy(~Habitat+Depth.zone, data=subset(mac_s, Condition=="C" & Wt>7.812500e-03))
wt <- lapply(hab, FUN=function(x)x$Wt)
out <- lapply(wt, FUN=function(x)LBNbiom.method(x, binBreaks=bks))
nbss <- ldply(lapply(out, FUN=function(x)x$binVals), data.frame)
info <- ldply(strsplit(nbss$.id, split="[|]"))
names(info) <- c("Habitat", "Depth")
nbss <- cbind(info, nbss[, -1])

out <- lapply(wt, FUN=MLE.method)
# size specutrum slope estimate by MLE
lapply(out, FUN=function(x)x[1:2])
plb <- ldply(lapply(out, FUN=function(x)x$PLB))
info <- ldply(strsplit(plb$.id, split="[|]"))
names(info) <- c("Habitat", "Depth")
plb <- cbind(info, plb[, -1])

ggplot(data=ldply(hab), 
       aes(x=log10(Wt), fill=Habitat))+
  geom_density(alpha=0.5)+
  scale_fill_manual(values=c("black", "gray"))+
  facet_wrap(~Depth.zone, scales="free")+
  labs(y="Frequency", x=expression(Log[10]~body~size~(mg)))+
  theme_bw() %+replace% large #%+replace% dark

ggplot(data=nbss, aes(x=log10binMid, y=log10totalBiomNorm, colour=Habitat))+
  geom_point(size=3)+
  scale_colour_manual(values=c("black","gray"))+
  geom_path(data=plb, aes(x=log10(x.PLB), y=log10(B.PLB)))+
  geom_path(data=plb, aes(x=log10(x.PLB), y=log10(B.PLB.LC)), linetype=2)+
  geom_path(data=plb, aes(x=log10(x.PLB), y=log10(B.PLB.UC)), linetype=2)+
  facet_wrap(~Depth, scales="free")+
  labs(x=expression(Log[10]~"mid-point of"~size~class~(mg)), y=expression(Log[10]~normalized~biomass))+
  theme_bw()%+replace% large #%+replace% dark

# Rank individual weight
SortWt <- lapply(hab, FUN=function(x)cbind(rank=1:length(x$Wt), weight=sort(x$Wt, decreasing=TRUE)))
SortWt <- ldply(SortWt)
info <- ldply(strsplit(SortWt$.id, split="[|]"))
names(info) <- c("Habitat", "Depth")
SortWt <- cbind(info, SortWt[, -1])

ggplot(data=SortWt, aes(x=weight, y=rank, colour=Habitat))+
  geom_point(size=3)+
  geom_path(data=plb, aes(x=x.PLB, y=y.PLB))+
  geom_path(data=plb, aes(x=x.PLB, y=y.PLB.LC), linetype=2)+
  geom_path(data=plb, aes(x=x.PLB, y=y.PLB.UC), linetype=2)+
  scale_colour_manual(values=c("black","gray"))+
  facet_wrap(~Depth, scales="free")+
  scale_x_log10(expression(Individual~weight~(mg)))+
  scale_y_log10("Individual rank", limits=c(1, NA))+
  theme_bw() %+replace% large %+replace% rotate #%+replace% dark 
```

# NBSS and ISD by cruise, habitat and depth strata
## All size classes

```{r, fig.width=10, fig.height=8}
hab <- splitBy(~Cruise+Habitat+Depth.zone, data=subset(mac_s, Condition=="C"))
wt <- lapply(hab, FUN=function(x)x$Wt)
out <- lapply(wt, FUN=function(x)LBNbiom.method(x, binBreaks=bks))
nbss <- ldply(lapply(out, FUN=function(x)x$binVals), data.frame)
info <- ldply(strsplit(nbss$.id, split="[|]"))
names(info) <- c("Cruise", "Habitat", "Depth")
nbss <- cbind(info, nbss[, -1])

ggplot(data=ldply(hab), 
       aes(x=log10(Wt), fill=Habitat))+
  geom_density(alpha=0.5)+
  scale_fill_manual(values=c("black", "gray"))+
  facet_grid(Cruise~Depth.zone, scales="free")+
  labs(y="Frequency", x=expression(Log[10]~body~size~(mg)))+
  theme_bw() %+replace% large #%+replace% dark

ggplot(data=nbss, aes(x=log10binMid, y=log10totalBiom, colour=Habitat))+
  geom_point(size=3)+
  geom_path(size=1)+
  scale_colour_manual(values=c("black","gray"))+
  facet_grid(Cruise~Depth, scales="free")+
  labs(x=expression(Log[10]~"mid-point of"~size~class~(mg)), y=expression(Log[10]~biomass~(mg~m^-2)))+
  theme_bw()%+replace% large #%+replace% dark

ggplot(data=nbss, aes(x=log10binMid, y=log10totalBiomNorm, colour=Habitat))+
  geom_point(size=3)+
  geom_path(size=1)+
  scale_colour_manual(values=c("black","gray"))+
  facet_grid(Cruise~Depth, scales="free")+
  labs(x=expression(Log[10]~"mid-point of"~size~class~(mg)), y=expression(Log[10]~normalized~biomass))+
  theme_bw()%+replace% large #%+replace% dark
```

## Size classes > 7.812500e-03

```{r, fig.width=10, fig.height=8}
# Only keep size < 7.812500e-03

hab <- splitBy(~Cruise+Habitat+Depth.zone, data=subset(mac_s, Wt > 7.812500e-03))
wt <- lapply(hab, FUN=function(x)x$Wt)
out <- lapply(wt, FUN=function(x)LBNbiom.method(x, binBreaks=bks))
nbss <- ldply(lapply(out, FUN=function(x)x$binVals), data.frame)
info <- ldply(strsplit(nbss$.id, split="[|]"))
names(info) <- c("Cruise", "Habitat", "Depth")
nbss <- cbind(info, nbss[, -1])

wt <- wt[unlist(lapply(wt, length))>21]
out <- lapply(wt, FUN=MLE.method)
# size specutrum slope estimate by MLE
lapply(out, FUN=function(x)x[1:2])
plb <- ldply(lapply(out, FUN=function(x)x$PLB))
info <- ldply(strsplit(plb$.id, split="[|]"))
names(info) <- c("Cruise", "Habitat", "Depth")
plb <- cbind(info, plb[, -1])

ggplot(data=ldply(hab), 
       aes(x=log10(Wt), fill=Habitat))+
  geom_density(alpha=0.5)+
  scale_fill_manual(values=c("black", "gray"))+
  facet_grid(Cruise~Depth.zone, scales="free")+
  labs(y="Frequency", x=expression(Log[10]~body~size~(mg)))+
  theme_bw() %+replace% large #%+replace% dark

ggplot(data=nbss, aes(x=log10binMid, y=log10totalBiomNorm, colour=Habitat))+
  geom_point(size=3)+
  scale_colour_manual(values=c("black","gray"))+
  geom_path(data=plb, aes(x=log10(x.PLB), y=log10(B.PLB)))+
  geom_path(data=plb, aes(x=log10(x.PLB), y=log10(B.PLB.LC)), linetype=2)+
  geom_path(data=plb, aes(x=log10(x.PLB), y=log10(B.PLB.UC)), linetype=2)+
  facet_grid(Cruise~Depth, scales="free")+
  labs(x=expression(Log[10]~"mid-point of"~size~class~(mg)), y=expression(Log[10]~normalized~biomass))+
  theme_bw()%+replace% large #%+replace% dark

# Rank individual weight
SortWt <- lapply(hab, FUN=function(x)cbind(rank=1:length(x$Wt), weight=sort(x$Wt, decreasing=TRUE)))
SortWt <- ldply(SortWt)
info <- ldply(strsplit(SortWt$.id, split="[|]"))
names(info) <- c("Cruise", "Habitat", "Depth")
SortWt <- cbind(info, SortWt[, -1])

ggplot(data=SortWt, aes(x=weight, y=rank, colour=Habitat))+
  geom_point(size=3)+
  geom_path(data=plb, aes(x=x.PLB, y=y.PLB))+
  geom_path(data=plb, aes(x=x.PLB, y=y.PLB.LC), linetype=2)+
  geom_path(data=plb, aes(x=x.PLB, y=y.PLB.UC), linetype=2)+
  scale_colour_manual(values=c("black","gray"))+
  facet_grid(Cruise~Depth, scales="free")+
  scale_x_log10(expression(Individual~weight~(mg)))+
  scale_y_log10("Individual rank", limits=c(1, NA))+
  theme_bw() %+replace% large %+replace% rotate #%+replace% dark 
```

# NBSS and ISD by habitat and dominant taxa
## All size classes

```{r, fig.width=12, fig.height=8}
hab <- splitBy(~Habitat+Taxon, data=subset(mac_s, Condition=="C"))
wt <- lapply(hab, FUN=function(x)x$Wt)
out <- lapply(wt, FUN=function(x)LBNbiom.method(x, binBreaks=bks))
nbss <- ldply(lapply(out, FUN=function(x)x$binVals), data.frame)
info <- ldply(strsplit(nbss$.id, split="[|]"))
names(info) <- c("Habitat", "Taxon")
nbss <- cbind(info, nbss[, -1])

wt <- wt[unlist(lapply(wt, length))>7]
out <- lapply(wt, FUN=MLE.method)
# size specutrum slope estimate by MLE
lapply(out, FUN=function(x)x[1:2])
plb <- ldply(lapply(out, FUN=function(x)x$PLB))
info <- ldply(strsplit(plb$.id, split="[|]"))
names(info) <- c("Habitat", "Taxon")
plb <- cbind(info, plb[, -1])

ggplot(data=ldply(hab), 
       aes(x=log10(Wt), fill=Habitat))+
  geom_density(alpha=0.5)+
  scale_fill_manual(values=c("black", "gray"))+
  facet_grid(Cruise~Category, scales="free")+
  labs(y="Frequency", x=expression(Log[10]~body~size~(mg)))+
  theme_bw() %+replace% large #%+replace% dark

ggplot(data=nbss, aes(x=log10binMid, y=log10totalBiom, colour=Habitat))+
  geom_point(size=3)+
  geom_path(size=1)+
  scale_colour_manual(values=c("black","gray"))+
  facet_wrap(~Taxon, scales="free")+
  labs(x=expression(Log[10]~"mid-point of"~size~class~(mg)), y=expression(Log[10]~biomass~(mg~m^-2)))+
  theme_bw()  %+replace% large  %+replace% rotate #%+replace% dark

ggplot(data=nbss, aes(x=log10binMid, y=log10totalBiomNorm, colour=Habitat))+
  geom_point(size=3)+
  geom_path(size=1)+
  scale_colour_manual(values=c("black","gray"))+
  #geom_path(data=plb, aes(x=log10(x.PLB), y=log10(B.PLB)))+
  #geom_path(data=plb, aes(x=log10(x.PLB), y=log10(B.PLB.LC)), linetype=2)+
  #geom_path(data=plb, aes(x=log10(x.PLB), y=log10(B.PLB.UC)), linetype=2)+
  facet_wrap(~Taxon, scales="free")+
  labs(x=expression(Log[10]~"mid-point of"~size~class~(mg)), y=expression(Log[10]~normalized~biomass))+
  theme_bw()  %+replace% large  %+replace% rotate #%+replace% dark 
```

```{r, fig.width=10, fig.height=10}
# Rank individual weight
SortWt <- lapply(hab, FUN=function(x)cbind(rank=1:length(x$Wt), weight=sort(x$Wt, decreasing=TRUE)))
SortWt <- ldply(SortWt)
info <- ldply(strsplit(SortWt$.id, split="[|]"))
names(info) <- c("Habitat", "Taxon")
SortWt <- cbind(info, SortWt[, -1])

ggplot(data=SortWt, aes(x=weight, y=rank, colour=Habitat))+
  geom_point(size=2)+
  scale_colour_manual(values=c("black","gray"))+
  geom_path(data=plb, aes(x=x.PLB, y=y.PLB))+
  geom_path(data=plb, aes(x=x.PLB, y=y.PLB.LC), linetype=2)+
  geom_path(data=plb, aes(x=x.PLB, y=y.PLB.UC), linetype=2)+
  facet_wrap(~Taxon, scales="free")+
  scale_x_log10(expression(Individual~weight~(mg)))+
  scale_y_log10("Individual rank", limits=c(1, NA))+
  theme_bw()%+replace% large %+replace% rotate #%+replace% dark 
```

# Mean body size of macrofauna
## By cruise and habitat

```{r, fig.width=7, fig.height=5}
library(knitr)
dat.mean <- summaryBy(Wt+Depth~Region+Habitat+Cruise+Station, data=subset(mac_s, Condition=="C"), FUN=c(mean, sd, length))
dat.mean$Wt.se <- dat.mean$Wt.sd/dat.mean$Wt.length^0.5
ggplot(data=dat.mean, 
       aes(x=Depth.mean, y=Wt.mean, 
           ymin=Wt.mean-Wt.se, ymax=Wt.mean+Wt.se,
           colour=Habitat, linetype=Habitat))+
  geom_point(size=5)+
  scale_colour_manual(values=c("black","gray"))+
  geom_errorbar()+
  stat_smooth(method="lm", formula=y~x, alpha=0.2, colour="gray20", se=FALSE)+
  scale_linetype_manual(values=c(1,2))+
  labs(x="Depth (m)", y=expression(Mean~body~size~(mg~indiv^-1)))+
  scale_y_log10()+
  theme_bw() %+replace% large

out <- dat.mean[, c("Region", "Habitat", "Cruise", "Station", "Depth.mean", "Wt.length", "Wt.mean", "Wt.sd", "Wt.se")]
names(out) <- c("Region", "Habitat", "Cruise", "Station", "Depth", "n", "Mean Size", "SD", "SE")
out$Depth <- round(out$Depth, 0)
out$`Mean Size` <- round(out$`Mean Size`, 2)
out$SD <- round(out$SD, 3)
out$SE <- round(out$SE, 3)
kable(out, align="c")
```

## By habitat

```{r, fig.width=7, fig.height=5}
dat.mean <- summaryBy(Wt+Depth~Region+Habitat+Station, data=mac_s, FUN=c(mean, sd, length))
dat.mean$Wt.se <- dat.mean$Wt.sd/dat.mean$Wt.length^0.5
ggplot(data=dat.mean, 
       aes(x=Depth.mean, y=Wt.mean, 
           ymin=Wt.mean-Wt.se, ymax=Wt.mean+Wt.se,
           colour=Habitat, linetype=Habitat))+
  geom_point(size=5)+
  scale_colour_manual(values=c("black","gray"))+
  geom_errorbar()+
  stat_smooth(method="lm", formula=y~x, alpha=0.2, colour="gray20", se=FALSE)+
  scale_linetype_manual(values=c(1,2))+
  labs(x="Depth (m)", y=expression(Mean~body~size~(mg~indiv^-1)))+
  scale_y_log10()+
  theme_bw() %+replace% large

out <- dat.mean[, c("Region", "Habitat", "Station", "Depth.mean", "Wt.length", "Wt.mean", "Wt.sd", "Wt.se")]
names(out) <- c("Region", "Habitat", "Station", "Depth", "n", "Mean Size", "SD", "SE")
out$Depth <- round(out$Depth, 0)
out$`Mean Size` <- round(out$`Mean Size`, 2)
out$SD <- round(out$SD, 3)
out$SE <- round(out$SE, 3)
kable(out, align="c")
```


